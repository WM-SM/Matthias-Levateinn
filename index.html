<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>마티아스: 레바테인</title>
    <style>
        body { 
            margin: 0; 
            background: #000 url('008_back.png') no-repeat center center fixed; 
            background-size: cover;
            color: white; 
            overflow: hidden; 
            font-family: 'Arial', sans-serif; 
            user-select: none; 
            touch-action: none;
        }
        canvas { 
            display: block; 
            background: rgba(26, 26, 26, 0.4); 
            cursor: crosshair;
            touch-action: none;
        }
        
        #overlay, #result-screen { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.7); 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            z-index: 100; 
            box-sizing: border-box; 
            padding: 20px; 
        }
        #result-screen { display: none; }
        
        #game-title, .result-title { 
            font-size: 8vw; 
            max-size: 60px;
            font-weight: bold; 
            color: #bc00ff; 
            text-shadow: 0 0 20px rgba(188, 0, 255, 0.6); 
            margin-bottom: 20px; 
            text-align: center;
        }
        
        #grid-container { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: auto auto;    
            gap: 20px; 
            width: 95%; 
            max-width: 1400px;
            align-items: center;
        }
        
        #description { 
            grid-column: 1; 
            grid-row: 1;
            font-size: 18px; 
            line-height: 1.6; 
            text-align: left; 
            color: #fff; 
            text-shadow: 2px 2px 4px #000;
            word-break: keep-all;
        }
        
        #char-img-container { 
            grid-column: 2; 
            grid-row: 1;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #char-img { max-width: 100%; max-height: 40vh; object-fit: contain; }
        
        .btn-wrapper-left { grid-column: 1; grid-row: 2; display: flex; justify-content: center; }
        .btn-wrapper-right { grid-column: 2; grid-row: 2; display: flex; justify-content: center; }

        .btn { padding: 15px 30px; font-size: 24px; font-weight: bold; color: white; background: #e67e22; border: none; border-radius: 12px; cursor: pointer; pointer-events: auto; display: flex; align-items: center; justify-content: center; transition: background 0.2s; min-width: 150px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .btn:hover { background: #d35400; }

        #copyright-notice {
            position: absolute;
            bottom: 10px;
            width: 90%;
            text-align: center;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.3;
            pointer-events: none;
        }

        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
        
        #ui-left-top { position: absolute; top: 15px; left: 15px; display: flex; flex-direction: column; gap: 5px; }
        #timer { font-size: 32px; color: #ffeb3b; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        .score-box { font-size: 20px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        .combo-box { font-size: 20px; color: #bc00ff; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        
        #ui-right-top-container { position: absolute; top: 15px; right: 15px; display: flex; flex-direction: column; align-items: flex-end; gap: 10px; pointer-events: auto; }
        #ui-face-box { width: 100px; height: 100px; border: 2px solid #bc00ff; border-radius: 10px; background: rgba(0,0,0,0.7); overflow: hidden; }
        #face-img { width: 100%; height: 100%; object-fit: cover; }
        
        .volume-controls { background: rgba(0, 0, 0, 0.8); border: 1px solid #bc00ff; border-radius: 8px; padding: 8px; width: 120px; box-sizing: border-box; }
        .volume-row { display: flex; flex-direction: column; gap: 2px; margin-bottom: 5px; }
        .volume-label { font-size: 10px; color: #bc00ff; font-weight: bold; display: flex; justify-content: space-between; }
        .volume-slider { width: 100%; cursor: pointer; accent-color: #bc00ff; }

        #ui-left-bottom { position: absolute; bottom: 15px; left: 15px; display: flex; gap: 5px; }
        .heart { width: 40px; height: 40px; object-fit: contain; }
        .heart-lost { opacity: 0.1; filter: grayscale(1); }
        
        #giveup-container { position: absolute; bottom: 15px; right: 15px; pointer-events: auto; }
        #giveup-btn { background: #c0392b; padding: 10px 20px; font-size: 16px; min-width: 80px; }

        .gauge-container { width: 150px; height: 10px; background: #333; border-radius: 5px; overflow: hidden; margin-top: 5px; border: 1.5px solid #555; }
        #fever-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #ff9800, #ffeb3b); }
        #combo-display { position: absolute; top: 35%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; font-weight: bold; color: #ffeb3b; display: none; z-index: 50; text-shadow: 4px 4px 8px #000; }
        
        #flash-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; opacity: 0; z-index: 60; transition: opacity 0.3s; }

        #result-grid { display: grid; grid-template-columns: 1fr; gap: 20px; align-items: center; margin-bottom: 20px; text-align: center;}
        .result-info p { font-size: 28px; margin: 5px 0; text-shadow: 2px 2px 4px #000; }
        #result-char-img { max-width: 100%; max-height: 30vh; object-fit: contain; }

        #creator-tag {
            position: absolute;
            bottom: 10px;
            right: 10px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.5);
        }

        @media (min-width: 768px) {
            #game-title, .result-title { font-size: 60px; }
            #description { font-size: 28px; }
            #char-img { max-height: 600px; }
            .btn { padding: 20px 60px; font-size: 32px; min-width: 250px; }
            #ui-face-box { width: 234px; height: 234px; }
            .volume-controls { width: 234px; padding: 10px; }
            .volume-label { font-size: 14px; }
            #timer { font-size: 52px; }
            .score-box, .combo-box { font-size: 31.2px; }
            .gauge-container { width: 325px; height: 20px; }
            .heart { width: 150px; height: 150px; }
            #result-grid { grid-template-columns: 1fr 1fr; text-align: left; }
            .result-info p { font-size: 50px; }
            #combo-display { font-size: 90px; }
        }
    </style>
</head>
<body>

<div id="flash-overlay"></div>

<div id="overlay">
    <div id="game-title">마티아스: 레바테인</div>
    <div id="grid-container">
        <div id="description">
            형님과 누님을 죽이고 검을 취했다.<br>
            어떤 흔적도 남지 않았겠지.<br>
            하지만 의심받았고, 저항 없이 나락에 떨어졌다.<br>
            그래도 웃음을 잃지 않았다.<br>
            이 전설의 검은 내 것이니까.
        </div>
        <div id="char-img-container">
            <img id="char-img" src="001.png" alt="Character">
        </div>
        <div class="btn-wrapper-left">
            <button class="btn" onclick="showTutorial()">게임 설명</button>
        </div>
        <div class="btn-wrapper-right">
            <button id="main-btn" class="btn">게임 시작</button>
        </div>
    </div>
    <div id="copyright-notice">
        이 게임은 프로젝트문 창작물의 2차창작 팬게임입니다. 비영리 목적이며, 원작자의 가이드라인을 최대한 준수하고자 합니다.<br>
        포함된 아트워크의 저작권은 원저작권자인 프로젝트문이 가지고 있음을 알립니다.
    </div>
</div>

<div id="result-screen">
    <div class="result-title">GAME OVER</div>
    <div id="result-grid">
        <div class="result-info">
            <p>최종 점수: <span id="final-score" style="color:#ffeb3b;">0</span></p>
            <p>최고 콤보: <span id="max-combo" style="color:#bc00ff;">0</span></p>
        </div>
        <div style="position: relative;">
            <img id="result-char-img" src="002_3_lose.png" alt="Lose Face">
        </div>
    </div>
    <button id="retry-btn" class="btn">처음으로</button>
    <div id="creator-tag">2차창작 팬게임 제작: 랑월</div>
</div>

<div id="game-ui">
    <div id="ui-left-top">
        <div id="timer">90</div>
        <div class="score-box">SCORE: <span id="score">0</span></div>
        <div class="combo-box">COMBO: <span id="current-combo-ui">0</span></div>
        <div class="gauge-container"><div id="fever-bar"></div></div>
    </div>
    
    <div id="ui-right-top-container">
        <div id="ui-face-box"><img id="face-img" src="002_1_default.png" alt="Face UI"></div>
        <div class="volume-controls">
            <div class="volume-row">
                <div class="volume-label">BGM <span id="bgm-val">50%</span></div>
                <input type="range" id="bgm-slider" class="volume-slider" min="0" max="100" value="50">
            </div>
            <div class="volume-row">
                <div class="volume-label">SFX <span id="sfx-val">80%</span></div>
                <input type="range" id="sfx-slider" class="volume-slider" min="0" max="100" value="80">
            </div>
        </div>
    </div>

    <div id="ui-left-bottom">
        <img src="003_life.png" class="heart" id="heart-0" alt="Life">
        <img src="003_life.png" class="heart" id="heart-1" alt="Life">
        <img src="003_life.png" class="heart" id="heart-2" alt="Life">
    </div>

    <div id="giveup-container">
        <button id="giveup-btn" class="btn" onclick="gameOver()" style="height: auto;">포기하기</button>
    </div>

    <div id="combo-display">0 COMBO!</div>
</div>

<canvas id="gameCanvas"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const comboDiv = document.getElementById('combo-display');
const flashDiv = document.getElementById('flash-overlay');
const comboUI = document.getElementById('current-combo-ui');
const faceImgUI = document.getElementById('face-img');

// 시간 관리용 변수 (60FPS 기준 델타 타임)
let lastTime = 0;
let deltaTime = 1;

const sounds = {
    bgm: new Audio('001_main.mp3'),
    slash1: new Audio('002_slash.mp3'),
    slash2: new Audio('003_slash2.mp3'),
    defend: new Audio('004_defend.mp3'),
    debuff: new Audio('005_debuff.mp3'),
    spear: new Audio('006_spear.mp3'),
    combo: new Audio('007_combo.mp3'),
    lose: new Audio('008_lose.mp3')
};
sounds.bgm.loop = true;

let bgmVolume = 0.5;
let sfxVolume = 0.8;

const bgmSlider = document.getElementById('bgm-slider');
const sfxSlider = document.getElementById('sfx-slider');
const bgmValText = document.getElementById('bgm-val');
const sfxValText = document.getElementById('sfx-val');

bgmSlider.addEventListener('input', (e) => {
    bgmVolume = e.target.value / 100;
    bgmValText.innerText = e.target.value + "%";
    sounds.bgm.volume = bgmVolume;
});
sfxSlider.addEventListener('input', (e) => {
    sfxVolume = e.target.value / 100;
    sfxValText.innerText = e.target.value + "%";
});

function playSound(name) {
    if (sounds[name]) {
        const s = sounds[name].cloneNode();
        s.volume = sfxVolume;
        s.play().catch(e => console.log("Audio play failed", e));
    }
}
function stopBGM() { sounds.bgm.pause(); sounds.bgm.currentTime = 0; }
function startBGM() { sounds.bgm.volume = bgmVolume; sounds.bgm.play().catch(e => console.log("BGM play failed", e)); }

function resize() { 
    canvas.width = window.innerWidth; 
    canvas.height = window.innerHeight; 
}
window.addEventListener('resize', resize);
resize();

const images = {};
const imgSources = [
    '001.png', '002_1_default.png', '002_2_happy.png', '002_3_lose.png', 
    '003_1_fruit1.png', '003_2_fruit2.png', '003_3_fruit3.png', 
    '004_fruit_big.png', '005_fruit_spear.png', '005_1_spear.png', 
    '006_fruit_debuff.png', '007_fruit_depend.png', '003_life.png',
    '008_back.png'
];
imgSources.forEach(src => { images[src] = new Image(); images[src].src = src; });

let gameState = 'START';
let score = 0;
let timeLeft = 90;
let lives = 3;
let bestCombo = 0;
let fruits = [];
let slicedFruits = [];
let spearAttacks = [];
let trails = [];
let isDragging = false;
let feverPoints = 0;
let isFever = false;
let totalComboCount = 0; 
let strokeStartTime = 0;
let strokeCount = 0; 
let lastAngle = null;
let faceResetTimeout = null;

function setFace(type) {
    if (faceResetTimeout) clearTimeout(faceResetTimeout);
    if (type === 'HAPPY') faceImgUI.src = '002_2_happy.png';
    else if (type === 'LOSE') faceImgUI.src = '002_3_lose.png';
    else { faceImgUI.src = '002_1_default.png'; return; }
    faceResetTimeout = setTimeout(() => { if (gameState === 'PLAYING') faceImgUI.src = '002_1_default.png'; }, 2000);
}

class Fruit {
    constructor(type) {
        this.type = type;
        this.x = Math.random() * (canvas.width * 0.7) + (canvas.width * 0.15);
        this.y = canvas.height + 150;
        let baseSize = (window.innerWidth < 768) ? 60 : 150;
        this.size = (type === 'BIG') ? baseSize * 1.5 : baseSize;
        this.vx = (Math.random() - 0.5) * (canvas.width * 0.01);
        this.vy = -(canvas.height * 0.02 + Math.random() * 10);
        this.rotation = 0;
        this.rotSpeed = (Math.random() - 0.5) * 0.15;
        if (type === 'NORMAL') {
            const v = Math.floor(Math.random() * 3) + 1;
            this.img = images[`003_${v}_fruit${v}.png`];
        } else {
            this.img = images[{BIG: '004_fruit_big.png', DEPEND: '007_fruit_depend.png', DEBUFF: '006_fruit_debuff.png', SPEAR: '005_fruit_spear.png'}[type]];
        }
    }
    update(dt) { 
        // deltaTime 적용
        this.vy += 0.4 * dt; 
        this.x += this.vx * dt; 
        this.y += this.vy * dt; 
        this.rotation += this.rotSpeed * dt; 
    }
    draw() {
        if (this.img && this.img.complete) {
            ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.rotation);
            ctx.drawImage(this.img, -this.size, -this.size, this.size * 2, this.size * 2); ctx.restore();
        }
    }
}

class SpearProjectile {
    constructor(x, y) {
        this.x = x; 
        this.y = y; 
        this.img = images['005_1_spear.png'];
        this.targetX = canvas.width / 2;
        this.targetY = canvas.height;
        this.speed = 25;
        const angle = Math.atan2(this.targetY - y, this.targetX - x);
        this.vx = Math.cos(angle) * this.speed;
        this.vy = Math.sin(angle) * this.speed;
    }
    update(dt) {
        this.x += this.vx * dt;
        this.y += this.vy * dt;
        return (this.y < canvas.height + 100);
    }
    draw() {
        if (this.img && this.img.complete) {
            ctx.save();
            ctx.translate(this.x, this.y);
            ctx.rotate(Math.atan2(this.vy, this.vx) + Math.PI / 2);
            let sw = (window.innerWidth < 768) ? 80 : 200;
            let sh = (window.innerWidth < 768) ? 160 : 400;
            ctx.drawImage(this.img, -sw/2, -sh/2, sw, sh); 
            ctx.restore();
        }
    }
}

class SlicedEffect {
    constructor(x, y, img, size, angle, side) {
        this.x = x; this.y = y; this.img = img; this.size = size;
        this.vx = side === 'left' ? -7 : 7; this.vy = -6; this.rotation = angle; this.opacity = 1; this.side = side;
    }
    update(dt) { 
        this.vy += 0.5 * dt; 
        this.x += this.vx * dt; 
        this.y += this.vy * dt; 
        this.opacity -= 0.03 * dt; 
    }
    draw() {
        if (this.img && this.img.complete) {
            ctx.save(); ctx.globalAlpha = Math.max(0, this.opacity); ctx.translate(this.x, this.y); ctx.rotate(this.rotation);
            if (this.side === 'left') ctx.drawImage(this.img, 0, 0, this.img.width / 2, this.img.height, -this.size, -this.size, this.size, this.size * 2);
            else ctx.drawImage(this.img, this.img.width / 2, 0, this.img.width / 2, this.img.height, 0, -this.size, this.size, this.size * 2);
            ctx.restore();
        }
    }
}

function spawnCycle() {
    if (gameState !== 'PLAYING') return;
    let list = [];
    if (!isFever) {
        let normalCount = Math.floor(Math.random() * 3) + 3;
        for (let i = 0; i < normalCount; i++) list.push('NORMAL');
        if (Math.random() < 0.4) { list.push(['DEPEND', 'DEBUFF', 'SPEAR'][Math.floor(Math.random() * 3)]); list.push('NORMAL'); }
    } else {
        for (let i = 0; i < 9; i++) {
            let r = Math.random() * 100;
            if (r < 49) list.push('NORMAL'); else if (r < 98) list.push('BIG'); else list.push(['DEPEND', 'DEBUFF', 'SPEAR'][Math.floor(Math.random() * 3)]);
        }
    }
    list.forEach((type, i) => { setTimeout(() => { if (gameState === 'PLAYING') fruits.push(new Fruit(type)); }, i * 60); });
    setTimeout(spawnCycle, isFever ? 700 : (Math.random() * 2000 + 1000));
}

function handleDebuffLogic() {
    const r = Math.random() * 100;
    if (r < 20) { playSound(Math.random() > 0.5 ? 'slash1' : 'slash2'); return true; }
    totalComboCount = 0; strokeCount = 0; playSound('debuff');
    if (r < 90) {
        flashDiv.style.background = "rgba(188, 0, 255, 0.3)"; flashDiv.style.opacity = "1";
        setTimeout(() => { flashDiv.style.opacity = "0"; }, 1500); 
        if (r < 70 && r >= 50) timeLeft = Math.max(0, timeLeft - 5); else if (r >= 70) feverPoints = Math.floor(feverPoints / 2);
    } else {
        flashDiv.style.background = "rgba(255, 0, 0, 0.3)"; flashDiv.style.opacity = "1";
        setTimeout(() => { flashDiv.style.opacity = "0"; }, 1500); triggerLifeLoss();
    }
    return false; 
}

function triggerLifeLoss() {
    lives = Math.max(0, lives - 1); updateHearts(); playSound('lose'); setFace('LOSE');
    if (lives <= 0) gameOver();
}

function updateHearts() {
    for (let i = 0; i < 3; i++) {
        const h = document.getElementById(`heart-${i}`);
        if (h) h.className = i < lives ? 'heart' : 'heart heart-lost';
    }
}

function gameOver() {
    gameState = 'OVER'; stopBGM();
    document.getElementById('game-ui').style.display = 'none';
    document.getElementById('result-screen').style.display = 'flex';
    document.getElementById('final-score').innerText = Math.floor(score);
    document.getElementById('max-combo').innerText = bestCombo;
}

function showTutorial() {
    const tutorialContent = [
        "이상, 돈키호테, 홍루: 공격해 점수 획득",
        "에즈라: 공격을 막아냄",
        "모제스: 공격 시 다양한 패널티 발생",
        "베스파: 공격 시 체력 -1",
        "???: 공격해 더 많은 점수 획득"
    ];
    const box = document.createElement('div');
    box.style = "position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,0.95); padding:40px; border:3px solid #bc00ff; border-radius:20px; z-index:200; font-size:18px; color:white; white-space:pre-line; text-align:center; box-shadow: 0 0 30px rgba(188,0,255,0.4); width: 80%; max-width: 500px;";
    box.innerText = "게임 설명\n\n" + tutorialContent.join("\n") + "\n\n(클릭하여 닫기)";
    box.onclick = () => document.body.removeChild(box);
    document.body.appendChild(box);
}

function getCoord(e) {
    const rect = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const clientY = e.touches ? e.touches[0].clientY : e.clientY;
    return {
        x: clientX - rect.left,
        y: clientY - rect.top
    };
}

function inputStart(e) {
    if (gameState !== 'PLAYING') return;
    isDragging = true; 
    strokeCount = 0; 
    strokeStartTime = Date.now(); 
    lastAngle = null; 
    const pos = getCoord(e);
    trails = [{ x: pos.x, y: pos.y }];
}

function inputMove(e) {
    if (!isDragging || gameState !== 'PLAYING') return;
    if (e.cancelable) e.preventDefault();
    
    const pos = getCoord(e);
    const curr = { x: pos.x, y: pos.y };
    const last = trails[trails.length - 1];
    
    const angle = Math.atan2(curr.y - last.y, curr.x - last.x);
    if (lastAngle !== null) {
        let diff = Math.abs(angle - lastAngle); if (diff > Math.PI) diff = Math.PI * 2 - diff;
        if (diff > Math.PI / 2) { if (strokeCount > 0) totalComboCount = 0; strokeCount = 0; strokeStartTime = Date.now(); }
    }
    lastAngle = angle;

    for (let i = fruits.length - 1; i >= 0; i--) {
        const f = fruits[i];
        if (Math.hypot(f.x - curr.x, f.y - curr.y) < f.size * 0.8) {
            if (f.type === 'DEPEND') { 
                isDragging = false; 
                totalComboCount = 0; 
                playSound('defend'); 
                return; 
            }
            if (f.type === 'SPEAR') { 
                playSound('spear');
                spearAttacks.push(new SpearProjectile(f.x, f.y));
                fruits.splice(i, 1);
                return; 
            }
            if (f.type === 'DEBUFF') { 
                if (!handleDebuffLogic()) { fruits.splice(i, 1); return; } 
            }
            else playSound(Math.random() > 0.5 ? 'slash1' : 'slash2');
            
            slicedFruits.push(new SlicedEffect(f.x, f.y, f.img, f.size, f.rotation, 'left'));
            slicedFruits.push(new SlicedEffect(f.x, f.y, f.img, f.size, f.rotation, 'right'));
            
            let pts = (f.type === 'BIG' ? 3 : 1); 
            score += (isFever ? pts * 1.5 : pts);
            if (!isFever) feverPoints = Math.min(100, feverPoints + pts);
            strokeCount++; 
            fruits.splice(i, 1);
        }
    }
    trails.push(curr); if (trails.length > 10) trails.shift();
}

function inputEnd() {
    if (isDragging) {
        if (strokeCount >= 3 && (Date.now() - strokeStartTime <= 1000)) {
            totalComboCount++; bestCombo = Math.max(bestCombo, totalComboCount);
            if (!isFever) feverPoints = Math.min(100, feverPoints + (strokeCount * 2));
            playSound('combo'); setFace('HAPPY');
            comboDiv.innerText = `${totalComboCount} COMBO!`; comboDiv.style.display = 'block';
            setTimeout(() => { comboDiv.style.display = 'none'; }, 800);
        } else if (strokeCount > 0) { totalComboCount = 0; }
    }
    isDragging = false;
}

canvas.addEventListener('mousedown', inputStart);
window.addEventListener('mousemove', inputMove, { passive: false });
window.addEventListener('mouseup', inputEnd);

canvas.addEventListener('touchstart', (e) => { inputStart(e); }, { passive: false });
canvas.addEventListener('touchmove', (e) => { inputMove(e); }, { passive: false });
canvas.addEventListener('touchend', inputEnd, { passive: false });

function animate(currentTime) {
    // 델타 타임 계산 (60FPS 기준 16.67ms = deltaTime 1)
    if (!lastTime) lastTime = currentTime;
    const elapsed = currentTime - lastTime;
    lastTime = currentTime;
    deltaTime = elapsed / (1000 / 60);

    // 델타 타임이 너무 튀는 현상 방지 (백그라운드 복귀 등)
    if (deltaTime > 3) deltaTime = 1;

    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    if (gameState === 'PLAYING') {
        if (feverPoints >= 100 && !isFever) { isFever = true; timeLeft += 5; }
        if (isFever) { feverPoints -= 0.17 * deltaTime; if (feverPoints <= 0) { isFever = false; feverPoints = 0; } }
        document.getElementById('fever-bar').style.width = feverPoints + "%";
        comboUI.innerText = totalComboCount; 

        for (let i = fruits.length - 1; i >= 0; i--) { 
            fruits[i].update(deltaTime); 
            fruits[i].draw(); 
            if (fruits[i].y > canvas.height + 300) fruits.splice(i, 1); 
        }
        
        for (let i = slicedFruits.length - 1; i >= 0; i--) { 
            slicedFruits[i].update(deltaTime); 
            slicedFruits[i].draw(); 
            if (slicedFruits[i].opacity <= 0) slicedFruits.splice(i, 1); 
        }
        
        for (let i = spearAttacks.length - 1; i >= 0; i--) { 
            if (!spearAttacks[i].update(deltaTime)) { 
                triggerLifeLoss(); 
                spearAttacks.splice(i, 1); 
            } else {
                spearAttacks[i].draw(); 
            }
        }
    }

    if (isDragging && trails.length > 1) {
        ctx.beginPath(); 
        ctx.strokeStyle = "rgba(255,255,255,0.9)"; 
        ctx.lineWidth = (window.innerWidth < 768) ? 8 : 12; 
        ctx.lineCap = "round";
        ctx.lineJoin = "round";
        ctx.moveTo(trails[0].x, trails[0].y); 
        for (let i = 1; i < trails.length; i++) ctx.lineTo(trails[i].x, trails[i].y); 
        ctx.stroke();
    }
    
    document.getElementById('score').innerText = Math.floor(score); 
    document.getElementById('timer').innerText = Math.ceil(timeLeft);
    
    requestAnimationFrame(animate);
}

document.getElementById('main-btn').addEventListener('click', () => {
    gameState = 'PLAYING'; startBGM();
    score = 0; timeLeft = 90; lives = 3; feverPoints = 0; totalComboCount = 0; bestCombo = 0;
    fruits = []; slicedFruits = []; spearAttacks = []; updateHearts();
    document.getElementById('overlay').style.display = 'none'; 
    document.getElementById('game-ui').style.display = 'block'; 
    spawnCycle();
});
document.getElementById('retry-btn').addEventListener('click', () => { stopBGM(); location.reload(); });
setInterval(() => { if (gameState === 'PLAYING') { timeLeft--; if (timeLeft <= 0) gameOver(); } }, 1000);

// 애니메이션 루프 시작
requestAnimationFrame(animate);
</script>
</body>
</html>

